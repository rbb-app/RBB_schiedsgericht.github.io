<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<base href="/RBB_Scores/">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>RBB Scores</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<style>
:root { --bg:#fff; --fg:#000; --card:#f2f2f2; }
@media (prefers-color-scheme: dark){
  :root { --bg:#121212; --fg:#fff; --card:#1e1e1e; }
}
body{ font-family:Arial; margin:0; padding:10px; background:var(--bg); color:var(--fg); }

.app-icon-large{ display:block; margin:20px auto; width:120px; height:120px; }

.input-row{ display:flex; flex-direction:column; align-items:center; gap:4px; margin-bottom:10px; }
.input-top{ display:flex; gap:4px; align-items:center; flex-wrap:wrap; justify-content:center; }
.input-bottom{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:center; }

.bonus-toggle{
  display:inline-block;
  padding:4px 6px;
  border-radius:6px;
  font-size:0.75em;
  cursor:pointer;
  border:1px solid #666;
  user-select:none;
  min-width:30px;
  text-align:center;
  margin:1px;
}
.bonus-toggle.jb{ background:#e0ffe0; color:#4caf50; }
.bonus-toggle.jb.active{ background:#4caf50; color:#fff; }
.bonus-toggle.fb{ background:#ffe0f0; color:#e91e63; }
.bonus-toggle.fb.active{ background:#e91e63; color:#fff; }

input, select, button{padding:6px; font-size:14px; margin:4px;}
input[type=number]{ width:50px; text-align:center; }
button{ cursor:pointer; }

.container{display:flex;gap:10px;flex-wrap:wrap; position:relative;}
.team{ flex:1; background:var(--card); border-radius:10px; padding:10px; min-width:150px; transition: background 0.3s; }
.team.ok-bg{ background: rgba(76,175,80,0.15); }
.team.fail-bg{ background: rgba(244,67,54,0.15); }

.players{display:flex;flex-wrap:wrap;gap:6px;justify-content:center; position:relative;}
.player{ padding:10px; border:3px solid #666; border-radius:10px; min-width:60px; text-align:center; cursor:pointer; position:relative;}
.player.active{ background: rgba(0,255,0,0.25); }
.player .remove{ position:absolute; top:2px; right:4px; color:red; font-weight:bold; cursor:pointer; }

.player .bonus { position: absolute; font-size:0.7em; font-weight:bold; padding:1px 4px; border-radius:4px; pointer-events:none; }
.player .bonus.fb { top:2px; left:2px; background:#e91e63; color:#fff; }
.player .bonus.jb { bottom:2px; left:2px; background:#4caf50; color:#fff; }

.status{ text-align:center; font-weight:bold; margin-top:6px; }
.ok{color:#4caf50;} .fail{color:#f44336;}

.periods{ display:flex; gap:4px; justify-content:center; margin-top:0; margin-bottom:6px; flex-wrap:nowrap; }
.periods div{
  padding:6px 10px; border-radius:6px; border:1px solid #666; cursor:pointer;
  min-width:40px; text-align:center; background:#f2f2f2; color:#000; user-select:none;
  transition: background 0.2s, color 0.2s, transform 0.1s;
}
.periods div.active{ background:#4caf50; color:#fff; }
.periods div:active{ transform: scale(0.95); }

#gameView { padding-top:60px; } /* Abstand Statusbar */

.setup-line{ text-align:center; margin-bottom:6px; }
</style>
</head>
<body>

<!-- SETUP VIEW -->
<div id="setupView">
  <img src="icon.png" class="app-icon-large" alt="RBB Scores Icon">
  <div class="setup-line">Home: <input id="nameHeim"></div>
  <div class="setup-line">Guest: <input id="nameGast"></div>

  <h3>Add Player</h3>
  <div class="input-row">
    <div class="input-top">
      No.: <input id="num" type="number">
      Pts: <input id="pts" type="number" step="0.5" min="-0.5" max="4.5">
      <span id="jbToggle" class="bonus-toggle jb" onclick="toggleJB(this)">JB</span>
      <span id="fbToggle" class="bonus-toggle fb" onclick="toggleFB(this)">FB</span>
    </div>
    <div class="input-bottom">
      <select id="teamSelect">
        <option value="heim">Home</option>
        <option value="gast">Guest</option>
      </select>
      <button onclick="addPlayer()">+</button>
    </div>
  </div>

  <div class="container">
    <div class="team">
      <h3 id="heimTitleSetup"></h3>
      <div id="heimPlayersSetup" class="players"></div>
    </div>
    <div class="team">
      <h3 id="gastTitleSetup"></h3>
      <div id="gastPlayersSetup" class="players"></div>
    </div>
  </div>

  <div style="text-align:center;margin-top:10px;">
    <button onclick="startGame()">Start Game</button>
  </div>
</div>

<!-- GAME VIEW -->
<div id="gameView" style="display:none; position:relative;">
  <div class="periods" id="periods">
    <div data-period="1">Q1</div>
    <div data-period="2">Q2</div>
    <div data-period="3">Q3</div>
    <div data-period="4">Q4</div>
    <div data-period="V">OT</div>
  </div>

  <div class="container">
    <div class="team">
      <h3 id="heimTitle"></h3>
      <div id="heimPlayers" class="players"></div>
      <div style="text-align:center; margin-top:4px;">
        <button onclick="confirmChange('heim')">Confirm</button>
        <button onclick="undoChange('heim')">Undo</button>
      </div>
      <div id="heimStatus" class="status"></div>
    </div>
    <div class="team">
      <h3 id="gastTitle"></h3>
      <div id="gastPlayers" class="players"></div>
      <div style="text-align:center; margin-top:4px;">
        <button onclick="confirmChange('gast')">Confirm</button>
        <button onclick="undoChange('gast')">Undo</button>
      </div>
      <div id="gastStatus" class="status"></div>
    </div>
  </div>

  <div style="text-align:center;margin-top:10px;">
    <button onclick="endGame()">End Game</button>
  </div>
</div>

<script>
let players=[], active={heim:[],gast:[]}, tempActive={heim:[],gast:[]}, log=[], currentPeriod="1", gameStarted=false;
const setupView=document.getElementById("setupView");
const gameView=document.getElementById("gameView");
const periodsDiv=document.getElementById("periods");
let jbActive=false, fbActive=false;

function vibrate(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }
function toggleJB(el){ jbActive=!jbActive; el.classList.toggle("active", jbActive); }
function toggleFB(el){ fbActive=!fbActive; el.classList.toggle("active", fbActive); }

function setPeriod(p){ currentPeriod=p; renderPeriods(); vibrate(15); }
function renderPeriods(){ [...periodsDiv.children].forEach(d=>d.classList.toggle("active",d.dataset.period===currentPeriod)); }
[...periodsDiv.children].forEach(d=>d.onclick=()=>setPeriod(d.dataset.period));

function startGame(){
  if(players.length===0) return alert("Please add players first");
  gameStarted=true; setupView.style.display="none"; gameView.style.display="block"; 
  tempActive.heim=[...active.heim]; tempActive.gast=[...active.gast]; vibrate(50); render();
}

function endGame(){
  if(!confirm("Do you really want to end the game?")) return;
  let csv="Time;Period;Team;Players;Points\n";
  log.forEach(l=>csv+=`${l.time};${l.period};${l.team};${l.lineup.join(",")};${l.points}\n`);
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download="substitutions.csv"; a.click();
  players=[]; active={heim:[],gast:[]}; tempActive={heim:[],gast:[]}; log=[]; gameStarted=false;
  setupView.style.display="block"; gameView.style.display="none"; render();
}

function addPlayer(){
  const num=+document.getElementById("num").value;
  const pts=+document.getElementById("pts").value;
  const team=document.getElementById("teamSelect").value;
  if(!num||!pts) return;
  if(players.some(p=>p.team===team && p.num===num)){ alert("This number is already taken for this team!"); return; }
  if(players.filter(p=>p.team===team).length>=12){ alert("Maximum 12 players per team allowed!"); return; }

  let bonus=0; if(jbActive&&fbActive) bonus=2; else if(jbActive) bonus=1; else if(fbActive) bonus=1.5;
  const adjustedPts=pts-bonus;

  players.push({num, pts:adjustedPts, team, jb: jbActive, fb: fbActive});
  players.sort((a,b)=>a.num-b.num);

  document.getElementById("num").value=""; document.getElementById("pts").value="";
  jbActive=false; fbActive=false; document.getElementById("jbToggle").classList.remove("active"); document.getElementById("fbToggle").classList.remove("active");

  vibrate(10); render();
}

function removePlayer(num,team){
  players=players.filter(p=>!(p.num===num && p.team===team));
  active[team]=active[team].filter(n=>n!==num); tempActive[team]=[...active[team]];
  vibrate(30); render();
}

function toggle(team,num){
  const l=tempActive[team]; const i=l.indexOf(num);
  if(i>=0) l.splice(i,1); else if(l.length<5) l.push(num);
  render();
}

function confirmChange(team){
  const sum = tempActive[team].map(n=>players.find(p=>p.num==n)?.pts||0).reduce((a,b)=>a+b,0);
  if(sum>14.5){ alert("Cannot confirm: total points exceed 14.5!"); return; }
  active[team] = [...tempActive[team]];
  logChange(team);
  render();
}

function undoChange(team){
  tempActive[team] = [...active[team]]; 
  render();
}

function logChange(team){
  const lineup=tempActive[team];
  const sum=lineup.map(n=>players.find(p=>p.num==n)?.pts||0).reduce((a,b)=>a+b,0);
  log.push({time:new Date().toLocaleTimeString(), period:currentPeriod, team:team, lineup:[...lineup], points:sum.toFixed(1)});
}

function renderPlayers(team,target,isSetup){
  const div=document.getElementById(target); div.innerHTML="";
  players.filter(p=>p.team===team).forEach(p=>{
    const el=document.createElement("div"); el.className="player";
    el.innerHTML=`<strong>#${p.num}</strong><br>${p.pts.toFixed(1)}`;
    if(p.fb){ const b=document.createElement("div"); b.className="bonus fb"; b.textContent="FB"; el.appendChild(b);}
    if(p.jb){ const b=document.createElement("div"); b.className="bonus jb"; b.textContent="JB"; el.appendChild(b);}
    if(isSetup) el.innerHTML+=`<span class="remove" onclick="removePlayer(${p.num},'${team}')">Ã—</span>`;
    else{ if(tempActive[team].includes(p.num)) el.classList.add("active"); el.onclick=()=>toggle(team,p.num);}
    div.appendChild(el);
  });
}

function render(){
  document.getElementById("heimTitle").textContent=document.getElementById("nameHeim").value||"Home";
  document.getElementById("gastTitle").textContent=document.getElementById("nameGast").value||"Guest";
  document.getElementById("heimTitleSetup").textContent=document.getElementById("nameHeim").value||"Home";
  document.getElementById("gastTitleSetup").textContent=document.getElementById("nameGast").value||"Guest";

  renderPeriods();
  renderPlayers("heim","heimPlayersSetup",true);
  renderPlayers("gast","gastPlayersSetup",true);
  renderPlayers("heim","heimPlayers",false);
  renderPlayers("gast","gastPlayers",false);

  ["heim","gast"].forEach(team=>{
    const sum=tempActive[team].map(n=>players.find(p=>p.num==n)?.pts||0).reduce((a,b)=>a+b,0);
    const st=document.getElementById(team+"Status"); if(!st) return;
    st.textContent="Points: "+sum.toFixed(1);
    if(tempActive[team].toString()!==active[team].toString()){ st.textContent += " (Not confirmed)"; }
    st.className="status "+(sum<=14.5?"ok":"fail");
    const tdiv=st.closest(".team"); tdiv.classList.remove("ok-bg","fail-bg"); tdiv.classList.add(sum<=14.5?"ok-bg":"fail-bg");
  });
}

render();
</script>
</body>
</html>