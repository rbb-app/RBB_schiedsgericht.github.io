<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<base href="/RBB_Scores/">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>RBB Scores</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#fff; --fg:#000; --card:#f2f2f2;
  --ok:rgba(76,175,80,.18);
  --fail:rgba(244,67,54,.18);
}
@media(prefers-color-scheme:dark){
  :root{--bg:#121212;--fg:#fff;--card:#1e1e1e;}
}
body{
  margin:0;padding:12px;
  font-family:Arial;
  background:var(--bg);
  color:var(--fg);
}
button,input,select{
  font-size:14px;
  padding:6px;
}
h3{text-align:center;margin:8px 0;}
.hidden{display:none;}

.container{display:flex;gap:10px;flex-wrap:wrap;}
.team{
  flex:1;
  background:var(--card);
  border-radius:10px;
  padding:10px;
  min-width:150px;
  transition:.3s;
}
.team.ok{background:var(--ok);}
.team.fail{background:var(--fail);}

.players{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
.player{
  position:relative;
  min-width:60px;
  padding:8px;
  border:2px solid #666;
  border-radius:8px;
  text-align:center;
}
.player.active{background:rgba(0,255,0,.25);}
.remove{
  position:absolute;
  top:2px;right:4px;
  color:red;font-weight:bold;
  cursor:pointer;
}
.bonus{
  position:absolute;
  font-size:10px;
  font-weight:bold;
  padding:2px 4px;
  border-radius:4px;
  color:#fff;
}
.fb{top:2px;left:2px;background:#e91e63;}
.jb{bottom:2px;left:2px;background:#3f51b5;}

.input-line{
  display:flex;
  gap:6px;
  justify-content:center;
  align-items:center;
  flex-wrap:wrap;
}
.input-line input[type=number]{width:55px;text-align:center;}
.bonus-toggle{font-size:11px;padding:4px 6px;}

.periods{
  margin-top:env(safe-area-inset-top);
  display:flex;
  gap:6px;
  justify-content:center;
}
.periods div{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #666;
  cursor:pointer;
}
.periods .active{background:#4caf50;color:#fff;}

.status{text-align:center;font-weight:bold;margin-top:6px;}
.fail-text{color:#f44336;}
</style>
</head>

<body>

<!-- SETUP -->
<div id="setupView">
  <h3>Setup</h3>

  <div style="text-align:center">
    Home <input id="nameHeim" value="Home"><br>
    Guest <input id="nameGast" value="Guest">
  </div>

  <h3>Add Player</h3>
  <div class="input-line">
    No <input id="num" type="number">
    Pts <input id="pts" type="number" step="0.5">
    <button class="bonus-toggle" id="jbBtn">JB</button>
    <button class="bonus-toggle" id="fbBtn">FB</button>
  </div>
  <div class="input-line">
    <select id="teamSelect">
      <option value="heim">Home</option>
      <option value="gast">Guest</option>
    </select>
    <button onclick="addPlayer()">＋ Add</button>
  </div>

  <div class="container">
    <div class="team">
      <h3 id="heimTitleSetup"></h3>
      <div id="heimPlayersSetup" class="players"></div>
    </div>
    <div class="team">
      <h3 id="gastTitleSetup"></h3>
      <div id="gastPlayersSetup" class="players"></div>
    </div>
  </div>

  <div style="text-align:center;margin-top:10px">
    <button onclick="startGame()">Start Game</button>
  </div>
</div>

<!-- GAME -->
<div id="gameView" class="hidden">
  <div class="periods" id="periods">
    <div data-p="Q1">Q1</div>
    <div data-p="Q2">Q2</div>
    <div data-p="Q3">Q3</div>
    <div data-p="Q4">Q4</div>
    <div data-p="OT">OT</div>
  </div>

  <div class="container">
    <div class="team" id="heimTeam">
      <h3 id="heimTitle"></h3>
      <div id="heimPlayers" class="players"></div>
      <div id="heimActions" class="hidden">
        <button onclick="confirm('heim')">Confirm</button>
        <button onclick="undo('heim')">Undo</button>
      </div>
      <div id="heimStatus" class="status"></div>
    </div>

    <div class="team" id="gastTeam">
      <h3 id="gastTitle"></h3>
      <div id="gastPlayers" class="players"></div>
      <div id="gastActions" class="hidden">
        <button onclick="confirm('gast')">Confirm</button>
        <button onclick="undo('gast')">Undo</button>
      </div>
      <div id="gastStatus" class="status"></div>
    </div>
  </div>

  <div style="text-align:center;margin-top:10px">
    <button onclick="endGame()">End Game</button>
  </div>
</div>

<script>
let players=[],active={heim:[],gast:[]},tempActive={heim:[],gast:[]},log=[],period="Q1";
let jb=false,fb=false;

const vib=m=>navigator.vibrate&&navigator.vibrate(m);

jbBtn.onclick=()=>{jb=!jb;jbBtn.style.opacity=jb?1:.4;}
fbBtn.onclick=()=>{fb=!fb;fbBtn.style.opacity=fb?1:.4;}

function calcPts(p){
  let r=p;
  if(jb&&fb) r-=2;
  else if(jb) r-=1;
  else if(fb) r-=1.5;
  return r;
}

function addPlayer(){
  const n=+num.value,p=+pts.value,t=teamSelect.value;
  if(!n||isNaN(p))return;
  if(players.filter(x=>x.team===t).length>=12)return alert("Max 12 players");
  if(players.find(x=>x.team===t&&x.num===n))return alert("Number already exists");
  players.push({num:n,pts:calcPts(p),team:t,jb,fb});
  num.value=pts.value="";jb=fb=false;jbBtn.style.opacity=fbBtn.style.opacity=.4;
  render();vib(10);
}

function render(){
  heimTitle.textContent=nameHeim.value;
  gastTitle.textContent=nameGast.value;
  heimTitleSetup.textContent=nameHeim.value;
  gastTitleSetup.textContent=nameGast.value;

  renderList("heim","heimPlayersSetup",true);
  renderList("gast","gastPlayersSetup",true);
  renderList("heim","heimPlayers",false);
  renderList("gast","gastPlayers",false);

  ["heim","gast"].forEach(t=>{
    const sum=tempActive[t].reduce((a,n)=>a+(players.find(p=>p.num===n&&p.team===t)?.pts||0),0);
    const teamDiv=document.getElementById(t+"Team");
    const st=document.getElementById(t+"Status");
    const act=document.getElementById(t+"Actions");

    teamDiv.className="team "+(sum<=14.5?"ok":"fail");
    if(JSON.stringify(active[t])!==JSON.stringify(tempActive[t])){
      act.classList.remove("hidden");
      st.textContent="Not confirmed";
      st.className="status fail-text";
    }else{
      act.classList.add("hidden");
      st.textContent="";
    }
  });
}

function renderList(team,target,setup){
  const d=document.getElementById(target);d.innerHTML="";
  players.filter(p=>p.team===team).forEach(p=>{
    const e=document.createElement("div");
    e.className="player"+(tempActive[team].includes(p.num)?" active":"");
    e.innerHTML=`#${p.num}<br>${p.pts.toFixed(1)}`;
    if(p.fb)e.innerHTML+=`<div class="bonus fb">FB</div>`;
    if(p.jb)e.innerHTML+=`<div class="bonus jb">JB</div>`;
    if(setup)e.innerHTML+=`<div class="remove" onclick="players=players.filter(x=>x!==p);render()">×</div>`;
    else e.onclick=()=>toggle(team,p.num);
    d.appendChild(e);
  });
}

function toggle(t,n){
  const l=tempActive[t],i=l.indexOf(n);
  if(i>=0)l.splice(i,1);else if(l.length<5)l.push(n);
  vib(15);render();
}

function confirm(t){
  const sum=tempActive[t].reduce((a,n)=>a+(players.find(p=>p.num===n&&p.team===t)?.pts||0),0);
  if(sum>14.5)return alert(">14.5 pts not allowed");
  active[t]=[...tempActive[t]];
  log.push({time:new Date().toLocaleTimeString(),period,team:t,lineup:[...active[t]],points:sum});
  vib(30);render();
}
function undo(t){tempActive[t]=[...active[t]];render();}

function startGame(){
  tempActive={heim:[...active.heim],gast:[...active.gast]};
  setupView.classList.add("hidden");
  gameView.classList.remove("hidden");
  render();
}

function endGame(){
  let csv="Time;Period;Team;Players;Points\n";
  log.forEach(l=>csv+=`${l.time};${l.period};${l.team};${l.lineup};${l.points}\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="history.csv";a.click();
  localStorage.clear();location.reload();
}

document.querySelectorAll(".periods div").forEach(d=>{
  d.onclick=()=>{period=d.dataset.p;render();}
});

render();
</script>
</body>
</html>