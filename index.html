<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<base href="/RBB_Scores/">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>RBB Scores</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#fff; --fg:#000; --card:#f2f2f2;
  --ok:rgba(76,175,80,.18);
  --fail:rgba(244,67,54,.18);
}
@media(prefers-color-scheme:dark){
  :root{--bg:#121212;--fg:#fff;--card:#1e1e1e;}
}

body{
  margin:0; padding:12px;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg); color:var(--fg);
}

button,input,select{ font-size:14px; padding:6px; }
h3{text-align:center;margin:8px 0;}
.hidden{display:none;}

/* SAFE AREA */
#setupView{ padding-top:calc(env(safe-area-inset-top) + 8px); }

/* HEADER */
#appHeader{text-align:center;margin-bottom:10px;}
#appHeader img{ width:96px; height:96px; border-radius:20%; }

/* LAYOUT */
.container{ display:flex; gap:10px; flex-wrap:wrap; }
.team{ flex:1; background:var(--card); border-radius:10px; padding:10px; min-width:150px; transition:.3s; }
.team.ok{background:var(--ok);} .team.fail{background:var(--fail);}

/* PLAYERS */
.players{ display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
.player{ position:relative; min-width:60px; padding:8px; border:2px solid #666; border-radius:8px; text-align:center; cursor:pointer; }
.player.active{background:rgba(0,255,0,.25);}
.remove{ position:absolute; top:2px; right:4px; color:red; font-weight:bold; cursor:pointer; }

/* BONUS TAGS */
.bonus{ position:absolute; font-size:10px; font-weight:bold; padding:2px 4px; border-radius:4px; color:#fff; }
.fb{top:2px; left:2px; background:#e91e63;}
.jb{bottom:2px; left:2px; background:#3f51b5;}

/* INPUT */
.input-line{ display:flex; gap:6px; justify-content:center; align-items:center; flex-wrap:wrap; }
.input-line input[type=number]{ width:50px; text-align:center; }

/* BONUS BUTTONS */
.bonus-btn{ border:1px solid #666; border-radius:6px; padding:4px 8px; font-size:11px; opacity:.4; cursor:pointer; }
.bonus-btn.jb{background:#3f51b5;color:#fff;}
.bonus-btn.fb{background:#e91e63;color:#fff;}
.bonus-btn.active{opacity:1;}

/* PERIODS */
.periods{ margin-top:12px; margin-bottom:16px; display:flex; gap:6px; justify-content:center; }
.periods div{ padding:6px 10px; border-radius:6px; border:1px solid #666; cursor:pointer; }
.periods .active{ background:#4caf50; color:#fff; }

/* STATUS */
.status{text-align:center; font-weight:bold; margin-top:6px;}
.fail-text{color:#f44336;}
</style>
</head>

<body>

<!-- SETUP VIEW -->
<div id="setupView">
  <div id="appHeader">
    <img src="icon.png" alt="RBB Scores">
  </div>

  <h3>Setup</h3>

  <div style="text-align:center">
    Home <input id="nameHeim" value="Home"><br>
    Guest <input id="nameGast" value="Guest">
  </div>

  <h3>Add Player</h3>

  <div class="input-line">
    No <input id="num" type="number">
    Pts <input id="pts" type="number" step="0.5">
    <button id="jbBtn" class="bonus-btn jb">JB</button>
    <button id="fbBtn" class="bonus-btn fb">FB</button>
  </div>

  <div class="input-line">
    <select id="teamSelect">
      <option value="heim">Home</option>
      <option value="gast">Guest</option>
    </select>
    <button onclick="addPlayer()">＋ Add</button>
  </div>

  <div class="container">
    <div class="team">
      <h3 id="heimTitleSetup"></h3>
      <div id="heimPlayersSetup" class="players"></div>
    </div>
    <div class="team">
      <h3 id="gastTitleSetup"></h3>
      <div id="gastPlayersSetup" class="players"></div>
    </div>
  </div>

  <div style="text-align:center;margin-top:10px">
    <button onclick="startGame()">Start Game</button>
  </div>
</div>

<!-- GAME VIEW -->
<div id="gameView" class="hidden">

  <div class="periods" id="periods">
    <div data-p="Q1">Q1</div>
    <div data-p="Q2">Q2</div>
    <div data-p="Q3">Q3</div>
    <div data-p="Q4">Q4</div>
    <div data-p="OT">OT</div>
  </div>

  <div class="container">
    <div class="team" id="heimTeam">
      <h3 id="heimTitle"></h3>
      <div id="heimPlayers" class="players"></div>
      <div id="heimActions" class="hidden">
        <button onclick="confirmChange('heim')">Confirm</button>
        <button onclick="undoChange('heim')">Undo</button>
      </div>
      <div id="heimStatus" class="status"></div>
    </div>

    <div class="team" id="gastTeam">
      <h3 id="gastTitle"></h3>
      <div id="gastPlayers" class="players"></div>
      <div id="gastActions" class="hidden">
        <button onclick="confirmChange('gast')">Confirm</button>
        <button onclick="undoChange('gast')">Undo</button>
      </div>
      <div id="gastStatus" class="status"></div>
    </div>
  </div>

  <div style="text-align:center;margin-top:10px">
    <button onclick="downloadCSV()">Download CSV</button>
    <button onclick="endGame()">End Game</button>
  </div>
</div>

<script>
let players=[], active={heim:[],gast:[]}, tempActive={heim:[],gast:[]}, log=[], period="Q1";
let jb=false, fb=false;
const vib=m=>navigator.vibrate&&navigator.vibrate(m);

jbBtn.onclick=()=>{jb=!jb;jbBtn.classList.toggle("active",jb);};
fbBtn.onclick=()=>{fb=!fb;fbBtn.classList.toggle("active",fb);};

function calcPts(p){
  if(jb&&fb) return p-2;
  if(jb) return p-1;
  if(fb) return p-1.5;
  return p;
}

function addPlayer(){
  const n=+num.value, p=+pts.value, t=teamSelect.value;
  if(!n||isNaN(p)) return;
  if(players.filter(x=>x.team===t).length>=12) return alert("Max 12 players");
  if(players.find(x=>x.team===t&&x.num===n)) return alert("Number exists");

  players.push({num:n, pts:calcPts(p), team:t, jb, fb});
  num.value=pts.value="";
  jb=fb=false; jbBtn.classList.remove("active"); fbBtn.classList.remove("active");
  vib(10);
  render();
}

function removePlayer(num,team){
  players = players.filter(p=>!(p.num===num && p.team===team));
  tempActive[team] = tempActive[team].filter(n=>n!==num);
  active[team] = active[team].filter(n=>n!==num);
  render();
}

function renderList(team,target,setup){
  const d=document.getElementById(target);
  d.innerHTML="";
  players.filter(p=>p.team===team).forEach(p=>{
    const e=document.createElement("div");
    e.className="player"+(tempActive[team].includes(p.num)?" active":"");
    e.innerHTML=`#${p.num}<br>${p.pts.toFixed(1)}`;
    if(p.fb) e.innerHTML+=`<div class="bonus fb">FB</div>`;
    if(p.jb) e.innerHTML+=`<div class="bonus jb">JB</div>`;
    if(setup){
      e.innerHTML+=`<div class="remove" onclick="removePlayer(${p.num},'${p.team}')">×</div>`;
    }else{
      e.onclick=()=>toggle(team,p.num);
    }
    d.appendChild(e);
  });
}

function toggle(team,num){
  const l=tempActive[team];
  const i=l.indexOf(num);
  if(i>=0) l.splice(i,1); else if(l.length<5) l.push(num);
  vib(15);
  render();
}

function confirmChange(team){
  const sum=tempActive[team].reduce((a,n)=>a+(players.find(p=>p.team===team&&p.num===n)?.pts||0),0);
  if(sum>14.5) return alert(">14.5 pts not allowed");
  active[team]=[...tempActive[team]];
  log.push({time:new Date().toLocaleTimeString(),period,team,lineup:[...active[team]],points:sum});
  vib(30);
  render();
}

function undoChange(team){
  tempActive[team]=[...active[team]];
  render();
}

function render(){
  heimTitle.textContent=nameHeim.value;
  gastTitle.textContent=nameGast.value;
  heimTitleSetup.textContent=nameHeim.value;
  gastTitleSetup.textContent=nameGast.value;

  renderList("heim","heimPlayersSetup",true);
  renderList("gast","gastPlayersSetup",true);
  renderList("heim","heimPlayers",false);
  renderList("gast","gastPlayers",false);

  ["heim","gast"].forEach(t=>{
    const sum=tempActive[t].reduce((a,n)=>a+(players.find(p=>p.team===t&&p.num===n)?.pts||0),0);
    const teamDiv=document.getElementById(t+"Team");
    const st=document.getElementById(t+"Status");
    const act=document.getElementById(t+"Actions");

    // Team Punkte anzeigen
    st.textContent = `Points: ${sum.toFixed(1)}`;

    teamDiv.className="team "+(sum<=14.5?"ok":"fail");

    if(JSON.stringify(active[t])!==JSON.stringify(tempActive[t])){
      act.classList.remove("hidden");
      st.textContent += " (Changes not confirmed)";
      st.className="status fail-text";
    }else{
      act.classList.add("hidden");
      st.className="status";
    }
  });
}

function startGame(){
  tempActive={heim:[...active.heim],gast:[...active.gast]};
  period="Q1";

  setupView.classList.add("hidden");
  gameView.classList.remove("hidden");

  document.querySelectorAll(".periods div").forEach(d=>{
    d.classList.toggle("active", d.dataset.p==="Q1");
  });

  render();
}

function downloadCSV(){
  if(log.length===0){ alert("No entries yet"); return; }
  let csv="Time;Period;Team;Players;Points\n";
  log.forEach(l=>{
    csv+=`${l.time};${l.period};${l.team};${l.lineup.join(",")};${l.points}\n`;
  });
  const url=URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
  window.open(url); // funktioniert auch auf iOS Homescreen
}

function endGame(){
  downloadCSV();
  localStorage.clear();
  location.reload();
}

document.querySelectorAll(".periods div").forEach(d=>{
  d.onclick=()=>{
    period=d.dataset.p;
    document.querySelectorAll(".periods div").forEach(x=>x.classList.remove("active"));
    d.classList.add("active");
  };
});

render();
</script>

</body>
</html>