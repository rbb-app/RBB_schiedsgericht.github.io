<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>RBB Scores</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<style>
:root { --bg:#fff; --fg:#000; --card:#f2f2f2; }
@media (prefers-color-scheme: dark){
  :root { --bg:#121212; --fg:#fff; --card:#1e1e1e; }
}
body{
  font-family:Arial;
  margin:0;
  padding:10px;
  background:var(--bg);
  color:var(--fg);
}
h2,h3{text-align:center;}
input,select,button{
  padding:6px;
  font-size:15px;
  margin:4px;
}
input[type=number]{ text-align:center; }
button{ cursor:pointer; }

.container{display:flex;gap:10px;flex-wrap:wrap;}
.team{
  flex:1;
  background:var(--card);
  border-radius:10px;
  padding:10px;
  min-width:150px;
  transition: background 0.3s;
}
.team.ok-bg{ background: rgba(76,175,80,0.15); }
.team.fail-bg{ background: rgba(244,67,54,0.15); }

.players{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
.player{
  padding:10px;
  border:3px solid #666;
  border-radius:10px;
  min-width:60px;
  text-align:center;
  cursor:pointer;
  position:relative;
}
.player.active{
  background: rgba(0,255,0,0.25);
}
.player .remove{
  position:absolute;
  top:2px;
  right:4px;
  color:red;
  font-weight:bold;
  cursor:pointer;
}

.status{
  text-align:center;
  font-weight:bold;
  margin-top:6px;
}
.ok{color:#4caf50;}
.fail{color:#f44336;}

.periods{
  display:flex;
  gap:5px;
  justify-content:center;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.periods div{
  padding:12px 16px;
  border-radius:8px;
  border:1px solid #666;
  cursor:pointer;
  user-select:none;
  min-width:70px;
  text-align:center;
}
.periods div.active{
  background:#4caf50;
  color:#fff;
}

.input-row{
  display:flex;
  flex-wrap:wrap;
  gap:5px;
  justify-content:center;
  margin-bottom:10px;
}
.input-row input,
.input-row select{
  width:60px;
  text-align:center;
  text-align-last:center;
}
.setup-line{
  text-align:center;
  margin-bottom:6px;
}
</style>
</head>

<body>

<h2>RBB Scores</h2>

<!-- SETUP VIEW -->
<div id="setupView">

<h3>Spiel-Setup</h3>
<div class="setup-line">Heim: <input id="nameHeim"></div>
<div class="setup-line">Gast: <input id="nameGast"></div>

<div style="text-align:center;margin-top:10px;">
  <button onclick="startGame()">Spiel starten</button>
</div>

<h3>Spieler anlegen</h3>
<div class="input-row">
Nr: <input id="num" type="number">
Pkt: <input id="pts" type="number" step="0.5" min="-0.5" max="4.5">
<select id="teamSelect">
  <option value="heim">Heim</option>
  <option value="gast">Gast</option>
</select>
<button onclick="addPlayer()">+</button>
</div>

<div class="container">
  <div class="team">
    <h3 id="heimTitleSetup"></h3>
    <div id="heimPlayersSetup" class="players"></div>
  </div>
  <div class="team">
    <h3 id="gastTitleSetup"></h3>
    <div id="gastPlayersSetup" class="players"></div>
  </div>
</div>

</div>

<!-- GAME VIEW -->
<div id="gameView" style="display:none;">

<div class="periods" id="periods">
  <div data-period="1">1. Viertel</div>
  <div data-period="2">2. Viertel</div>
  <div data-period="3">3. Viertel</div>
  <div data-period="4">4. Viertel</div>
  <div data-period="V">Verlängerung</div>
</div>

<div class="container">
<div class="team">
<h3 id="heimTitle"></h3>
<div id="heimPlayers" class="players"></div>
<div id="heimStatus" class="status"></div>
</div>

<div class="team">
<h3 id="gastTitle"></h3>
<div id="gastPlayers" class="players"></div>
<div id="gastStatus" class="status"></div>
</div>
</div>

<div style="text-align:center;margin-top:10px;">
<button onclick="endGame()">Spiel beenden</button>
</div>

</div>

<script>
let players=[];
let active={heim:[],gast:[]};
let log=[];
let currentPeriod="1";
let gameStarted=false;

const setupView=document.getElementById("setupView");
const gameView=document.getElementById("gameView");
const periodsDiv=document.getElementById("periods");

function vibrate(ms=20){
  if(navigator.vibrate) navigator.vibrate(ms);
}

function setPeriod(p){
  currentPeriod=p;
  renderPeriods();
  vibrate(15);
}
function renderPeriods(){
  [...periodsDiv.children].forEach(d=>{
    d.classList.toggle("active",d.dataset.period===currentPeriod);
  });
}
[...periodsDiv.children].forEach(d=>{
  d.onclick=()=>setPeriod(d.dataset.period);
});

function startGame(){
  if(players.length===0) return alert("Bitte Spieler anlegen");
  gameStarted=true;
  setupView.style.display="none";
  gameView.style.display="block";
  vibrate(50);
  render();
}

function endGame(){
  if(!confirm("Spiel wirklich beenden?")) return;
  let csv="Zeit;Periode;Team;Spieler;Punkte\n";
  log.forEach(l=>{
    csv+=`${l.time};${l.period};${l.team};${l.lineup.join(",")};${l.points}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="wechselhistorie.csv";
  a.click();

  players=[]; active={heim:[],gast:[]}; log=[];
  gameStarted=false;
  setupView.style.display="block";
  gameView.style.display="none";
  render();
}

function addPlayer(){
  const num=document.getElementById("num");
  const pts=document.getElementById("pts");
  const team=document.getElementById("teamSelect").value;
  if(!num.value||!pts.value) return;
  players.push({num:+num.value,pts:+pts.value,team});
  players.sort((a,b)=>a.num-b.num);
  num.value=""; pts.value="";
  vibrate(10);
  render();
}

function removePlayer(num,team){
  players=players.filter(p=>!(p.num===num && p.team===team));
  active[team]=active[team].filter(n=>n!==num);
  vibrate(30);
  render();
}

function toggle(team,num){
  const l=active[team];
  const i=l.indexOf(num);
  if(i>=0) l.splice(i,1);
  else if(l.length<5) l.push(num);
  logChange(team);
  vibrate(20);
  render();
}

function logChange(team){
  const lineup=active[team];
  const sum=lineup.map(n=>players.find(p=>p.num==n)?.pts||0)
    .reduce((a,b)=>a+b,0);
  log.push({
    time:new Date().toLocaleTimeString(),
    period:currentPeriod,
    team:team,
    lineup:[...lineup],
    points:sum.toFixed(1)
  });
}

function renderPlayers(team,target,isSetup){
  const div=document.getElementById(target);
  div.innerHTML="";
  players.filter(p=>p.team===team).forEach(p=>{
    const el=document.createElement("div");
    el.className="player";
    el.innerHTML=`<strong>#${p.num}</strong><br>${p.pts.toFixed(1)}`;
    if(isSetup){
      el.innerHTML+=`<span class="remove" onclick="removePlayer(${p.num},'${team}')">×</span>`;
    }else{
      if(active[team].includes(p.num)) el.classList.add("active");
      el.onclick=()=>toggle(team,p.num);
    }
    div.appendChild(el);
  });
}

function render(){
  heimTitle.textContent=nameHeim.value||"Heim";
  gastTitle.textContent=nameGast.value||"Gast";
  heimTitleSetup.textContent=nameHeim.value||"Heim";
  gastTitleSetup.textContent=nameGast.value||"Gast";

  renderPeriods();
  renderPlayers("heim","heimPlayersSetup",true);
  renderPlayers("gast","gastPlayersSetup",true);
  renderPlayers("heim","heimPlayers",false);
  renderPlayers("gast","gastPlayers",false);

  ["heim","gast"].forEach(team=>{
    const sum=active[team].map(n=>players.find(p=>p.num==n)?.pts||0)
      .reduce((a,b)=>a+b,0);
    const st=document.getElementById(team+"Status");
    if(!st) return;
    st.textContent="Punkte: "+sum.toFixed(1);
    st.className="status "+(sum<=14.5?"ok":"fail");
    const tdiv=st.closest(".team");
    tdiv.classList.remove("ok-bg","fail-bg");
    tdiv.classList.add(sum<=14.5?"ok-bg":"fail-bg");
  });
}

render();
</script>

</body>
</html>
