<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<base href="/RBB_Scores/">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover,
               user-scalable=no, maximum-scale=1">

<title>RBB Scores</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#fff; --fg:#000; --card:#f2f2f2;
  --ok:rgba(76,175,80,.18);
  --fail:rgba(244,67,54,.18);
  --danger:#d32f2f;
}
@media(prefers-color-scheme:dark){
  :root{--bg:#121212;--fg:#fff;--card:#1e1e1e;}
}
body{margin:0;padding:12px;font-family:Arial;background:var(--bg);color:var(--fg);}
button,input,select{font-size:14px;padding:6px;}
.hidden{display:none;}

#appHeader{text-align:center;margin-bottom:10px;}
#appHeader img{width:96px;height:96px;border-radius:20%;}

.container{display:flex;gap:10px;flex-wrap:wrap;}
.team{flex:1;background:var(--card);border-radius:10px;padding:10px;min-width:150px;transition:.3s;}
.team.ok{background:var(--ok);}
.team.fail{background:var(--fail);}

.players{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
.player{position:relative;min-width:60px;padding:8px;border:2px solid #666;border-radius:8px;text-align:center;cursor:pointer;}
.player.active{background:rgba(0,255,0,.25);}
.remove{position:absolute;top:2px;right:4px;color:red;font-weight:bold;cursor:pointer;}

.bonus{position:absolute;font-size:10px;font-weight:bold;padding:2px 4px;border-radius:4px;color:#fff;}
.fb{top:2px;left:2px;background:#e91e63;}
.jb{bottom:2px;left:2px;background:#3f51b5;}

.bonus-btn{border:1px solid #666;border-radius:6px;padding:4px 8px;font-size:11px;opacity:.4;cursor:pointer;}
.bonus-btn.jb{background:#3f51b5;color:#fff;}
.bonus-btn.fb{background:#e91e63;color:#fff;}
.bonus-btn.active{opacity:1;}

.periods{display:flex;gap:6px;justify-content:center;margin:10px 0;}
.periods div{padding:6px 8px;border-radius:6px;border:1px solid #666;cursor:pointer;}
.periods .active{background:#4caf50;color:#fff;}

.status{text-align:center;font-weight:bold;margin-top:6px;}

.danger-btn{
  background:var(--danger);
  color:#fff;border:none;border-radius:8px;
  padding:10px 16px;font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ================= SETUP VIEW ================= -->
<div id="setupView">

<div id="appHeader">
<img src="icon.png" alt="RBB Scores">
</div>

<h3 style="text-align:center;">Setup</h3>

<div style="text-align:center">
Home <input id="nameHeim" value="Home"><br>
Guest <input id="nameGast" value="Guest">
</div>

<h3 style="text-align:center;">Add Player</h3>

<div style="text-align:center;margin-bottom:8px;">
No <input id="num" type="number">

Pts 
<select id="pts">
<option value="">--</option>
<option value="1.0">1.0</option>
<option value="1.5">1.5</option>
<option value="2.0">2.0</option>
<option value="2.5">2.5</option>
<option value="3.0">3.0</option>
<option value="3.5">3.5</option>
<option value="4.0">4.0</option>
<option value="4.5">4.5</option>
</select>

<button id="jbBtn" class="bonus-btn jb">JB</button>
<button id="fbBtn" class="bonus-btn fb">FB</button>

<select id="teamSelect">
<option value="heim">Home</option>
<option value="gast">Guest</option>
</select>

<button onclick="addPlayer()">＋ Add</button>
</div>

<div class="container">
<div class="team">
<h3 id="heimTitleSetup"></h3>
<div id="heimPlayersSetup" class="players"></div>
</div>
<div class="team">
<h3 id="gastTitleSetup"></h3>
<div id="gastPlayersSetup" class="players"></div>
</div>
</div>

<div style="text-align:center;margin-top:10px">
<button onclick="startGame()">Start Game View</button>
</div>

</div>

<!-- ================= GAME VIEW ================= -->
<div id="gameView" class="hidden">

<div class="periods">
<div data-p="Q1" class="active">Q1</div>
<div data-p="Q2">Q2</div>
<div data-p="Q3">Q3</div>
<div data-p="Q4">Q4</div>
<div data-p="OT">OT</div>
</div>

<div style="text-align:center;margin-bottom:10px;">
<div id="gameStatus"><strong>Game not started</strong></div>
<button onclick="startRealGame()" id="realStartBtn">▶ Start Game</button>
<button onclick="endQuarter()" id="endQuarterBtn" class="hidden">⏹ End Quarter</button>
<button onclick="nextQuarter()" id="nextQuarterBtn" class="hidden">▶ Start Next Quarter</button>
</div>

<div class="container">
<div class="team" id="heimTeam">
<h3 id="heimTitle"></h3>
<div id="heimPlayers" class="players"></div>
<div id="heimActions" class="hidden">
<button onclick="confirmChange('heim')">Confirm</button>
<button onclick="undoChange('heim')">Undo</button>
</div>
<div id="heimStatus" class="status"></div>
</div>

<div class="team" id="gastTeam">
<h3 id="gastTitle"></h3>
<div id="gastPlayers" class="players"></div>
<div id="gastActions" class="hidden">
<button onclick="confirmChange('gast')">Confirm</button>
<button onclick="undoChange('gast')">Undo</button>
</div>
<div id="gastStatus" class="status"></div>
</div>
</div>

<div style="text-align:center;margin-top:15px">
<button class="danger-btn" onclick="endGame()">⚠ End Game & Download CSV</button>
</div>

<div style="text-align:center;margin-top:10px">
<button onclick="adminReset()">Admin Reset</button>
</div>

</div>

<script>
let players=[];
let active={heim:[],gast:[]};
let tempActive={heim:[],gast:[]};
let log=[];
let period="Q1";
let gameRunning=false;
let jb=false,fb=false;

const jbBtn=document.getElementById("jbBtn");
const fbBtn=document.getElementById("fbBtn");

jbBtn.onclick=()=>{jb=!jb;jbBtn.classList.toggle("active",jb);};
fbBtn.onclick=()=>{fb=!fb;fbBtn.classList.toggle("active",fb);};

function calcPts(p){
if(jb&&fb) return p-2;
if(jb) return p-1;
if(fb) return p-1.5;
return p;
}

function addPlayer(){
const n=+num.value;
const p=parseFloat(pts.value);
const t=teamSelect.value;
if(!n||isNaN(p))return;
players.push({num:n,pts:calcPts(p),team:t,jb,fb});
num.value="";pts.value="";
jb=fb=false;
jbBtn.classList.remove("active");
fbBtn.classList.remove("active");
render();
}

function render(){
heimTitle.textContent=nameHeim.value;
gastTitle.textContent=nameGast.value;
heimTitleSetup.textContent=nameHeim.value;
gastTitleSetup.textContent=nameGast.value;
renderList("heim","heimPlayersSetup",true);
renderList("gast","gastPlayersSetup",true);
renderList("heim","heimPlayers",false);
renderList("gast","gastPlayers",false);
}

function renderList(team,target,setup){
const d=document.getElementById(target);
d.innerHTML="";
players.filter(p=>p.team===team).forEach(p=>{
const e=document.createElement("div");
e.className="player";
e.innerHTML=`#${p.num}<br>${p.pts.toFixed(1)}`;
if(p.fb) e.innerHTML+=`<div class="bonus fb">FB</div>`;
if(p.jb) e.innerHTML+=`<div class="bonus jb">JB</div>`;
if(setup) e.innerHTML+=`<div class="remove" onclick="removePlayer(${p.num},'${p.team}')">×</div>`;
d.appendChild(e);
});
}

function removePlayer(num,team){
players=players.filter(p=>!(p.num===num&&p.team===team));
render();
}

function startGame(){
setupView.classList.add("hidden");
gameView.classList.remove("hidden");
}

function startRealGame(){
gameRunning=true;
gameStatus.innerHTML="<strong>Game Running - "+period+"</strong>";
realStartBtn.classList.add("hidden");
endQuarterBtn.classList.remove("hidden");
}

function endQuarter(){
gameRunning=false;
gameStatus.innerHTML="<strong>"+period+" ended</strong>";
endQuarterBtn.classList.add("hidden");
nextQuarterBtn.classList.remove("hidden");
}

function nextQuarter(){
const order=["Q1","Q2","Q3","Q4","OT"];
let i=order.indexOf(period);
if(i<order.length-1) period=order[i+1];
document.querySelectorAll(".periods div").forEach(d=>{
d.classList.toggle("active", d.dataset.p===period);
});
gameRunning=true;
gameStatus.innerHTML="<strong>Game Running - "+period+"</strong>";
nextQuarterBtn.classList.add("hidden");
endQuarterBtn.classList.remove("hidden");
}

function adminReset(){
if(!confirm("Return to setup without deleting players?")) return;
gameRunning=false;
period="Q1";
active={heim:[],gast:[]};
tempActive={heim:[],gast:[]};
log=[];
gameView.classList.add("hidden");
setupView.classList.remove("hidden");
}

function endGame(){
if(!confirm("End game and download CSV?")) return;
let csv="Time;Period;Team;Players\n";
log.forEach(l=>{
csv+=`${l.time};${l.period};${l.team};${l.lineup.join(",")}\n`;
});
const a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
a.download="history.csv";
a.click();
location.reload();
}

render();
</script>

</body>
</html>