<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>RBB Schiedsgericht Punkte</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<style>
:root { --bg:#fff; --fg:#000; --card:#f2f2f2; }
@media (prefers-color-scheme: dark){
  :root { --bg:#121212; --fg:#fff; --card:#1e1e1e; }
}
body{
  font-family:Arial;
  margin:0;
  padding:10px;
  background:var(--bg);
  color:var(--fg);
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
input,select,button{padding:6px;font-size:15px;margin:3px;}
h2,h3{text-align:center;}
.container{display:flex;gap:10px;flex-wrap:wrap;}
.team{flex:1;border-radius:10px;padding:10px;min-width:140px;transition: background 0.3s;}
.players{display:flex;flex-wrap:wrap;gap:6px;}
.player{
  padding:10px;border:3px solid #666;border-radius:10px;
  min-width:60px;text-align:center;cursor:pointer;position:relative;
}
.player.active{background:rgba(0,255,0,.15);}
.player span.remove{
  position:absolute; top:2px; right:4px; color:red; font-weight:bold; cursor:pointer;
}
.status{text-align:center;font-weight:bold;margin-top:6px;}
button{cursor:pointer;}
.color-selects{margin-top:10px; display:flex; gap:20px; max-width:300px; justify-content:center; flex-wrap:wrap;}
.color-selects label{display:flex; align-items:center; gap:5px;}
</style>
</head>

<body>

<h2>Rollstuhlbasketball – Schiedsgericht</h2>

<h3>Spiel-Setup</h3>
<div style="text-align:center;">
Heim: <input id="nameHeim">
Gast: <input id="nameGast"><br>
Periode:
<select id="period">
  <option>1. Viertel</option>
  <option>2. Viertel</option>
  <option>3. Viertel</option>
  <option>4. Viertel</option>
  <option>Verlängerung</option>
</select><br>
<button onclick="startGame()">Spiel starten</button>
<button onclick="downloadLog()">Download Wechselhistorie</button>
</div>

<h3>Spieler anlegen</h3>
Nr: <input id="num" type="number">
Pkt: <input id="pts" type="number" step="0.5" min="-0.5" max="4.5">
Team:
<select id="teamSelect">
  <option value="heim">Heim</option>
  <option value="gast">Gast</option>
</select>
<button onclick="addPlayer()">+</button>

<div class="color-selects">
  <label>Heim Farbe: <input type="color" id="heimColor" value="#f2f2f2"></label>
  <label>Gast Farbe: <input type="color" id="gastColor" value="#f2f2f2"></label>
</div>

<div class="container">

<div class="team">
<h3 id="heimTitle"></h3>
<div id="heimPlayers" class="players"></div>
<div id="heimStatus" class="status"></div>
</div>

<div class="team">
<h3 id="gastTitle"></h3>
<div id="gastPlayers" class="players"></div>
<div id="gastStatus" class="status"></div>
</div>

</div>

<script>
let players = JSON.parse(localStorage.getItem("players")) || [];
let active = JSON.parse(localStorage.getItem("active")) || { heim:[], gast:[] };
let log = JSON.parse(localStorage.getItem("log")) || [];

const nameHeim = document.getElementById("nameHeim");
const nameGast = document.getElementById("nameGast");
const heimColorInput = document.getElementById("heimColor");
const gastColorInput = document.getElementById("gastColor");

nameHeim.value = localStorage.getItem("nameHeim") || "Heim";
nameGast.value = localStorage.getItem("nameGast") || "Gast";
heimColorInput.value = localStorage.getItem("heimColor") || "#f2f2f2";
gastColorInput.value = localStorage.getItem("gastColor") || "#f2f2f2";

heimColorInput.oninput = () => { saveColors(); render(); };
gastColorInput.oninput = () => { saveColors(); render(); };

function saveColors(){
  localStorage.setItem("heimColor", heimColorInput.value);
  localStorage.setItem("gastColor", gastColorInput.value);
}

function save(){
  localStorage.setItem("players", JSON.stringify(players));
  localStorage.setItem("active", JSON.stringify(active));
  localStorage.setItem("log", JSON.stringify(log));
  localStorage.setItem("nameHeim", nameHeim.value);
  localStorage.setItem("nameGast", nameGast.value);
  saveColors();
}

function startGame(){
  alert("Spiel gestartet: " + new Date().toLocaleString());
}

function addPlayer(){
  const num = document.getElementById("num");
  const pts = document.getElementById("pts");
  const teamSelect = document.getElementById("teamSelect");
  if(!num.value || !pts.value) return;
  players.push({
    num: num.value,
    pts: parseFloat(pts.value),
    team: teamSelect.value
  });
  players.sort((a,b)=>a.num-b.num);
  save(); render();
  num.value=""; pts.value="";
}

function toggle(team, num){
  const list = active[team];
  const i = list.indexOf(num);
  if(i >= 0) list.splice(i,1);
  else if(list.length < 5) list.push(num);

  logChange(team);
  save(); render();
}

function removePlayer(num, team){
  players = players.filter(p => !(p.num==num && p.team===team));
  active[team] = active[team].filter(n => n!=num);
  save(); render();
}

function logChange(team){
  const lineup = active[team];
  const sum = lineup
    .map(n => players.find(p=>p.num==n)?.pts || 0)
    .reduce((a,b)=>a+b,0);

  log.push({
    time: new Date().toLocaleTimeString(),
    period: period.value,
    team: team==="heim" ? nameHeim.value : nameGast.value,
    lineup: [...lineup],
    points: sum.toFixed(1)
  });
}

function blendColors(hex, overlayHex, factor){
  // einfache lineare Mischung zwischen zwei Farben (0..1)
  const f = Math.min(Math.max(factor,0),1);
  const h = hex.replace('#','');
  const o = overlayHex.replace('#','');
  const r = Math.round(parseInt(h.substring(0,2),16)*(1-f) + parseInt(o.substring(0,2),16)*f);
  const g = Math.round(parseInt(h.substring(2,4),16)*(1-f) + parseInt(o.substring(2,4),16)*f);
  const b = Math.round(parseInt(h.substring(4,6),16)*(1-f) + parseInt(o.substring(4,6),16)*f);
  return `rgb(${r},${g},${b})`;
}

function render(){
  nameHeim.value && (heimTitle.textContent = nameHeim.value);
  nameGast.value && (gastTitle.textContent = nameGast.value);

  ["heim","gast"].forEach(team=>{
    const div = document.getElementById(team+"Players");
    div.innerHTML = "";
    const baseColor = team==="heim" ? heimColorInput.value : gastColorInput.value;

    const sum = active[team]
      .map(n=>players.find(p=>p.num==n)?.pts || 0)
      .reduce((a,b)=>a+b,0);

    // Dynamischer Hintergrund: grün wenn ok, rot wenn zu hoch
    const overlay = sum<=14.5 ? "#a4d6a7" : "#f7a1a1";
    div.parentElement.style.background = blendColors(baseColor, overlay, 0.4);

    players.filter(p=>p.team===team).forEach(p=>{
      const el = document.createElement("div");
      el.className = "player";
      el.innerHTML = `#${p.num}<br>${p.pts} <span class="remove" onclick="removePlayer(${p.num},'${team}')">×</span>`;
      if(active[team].includes(p.num)) el.classList.add("active");
      el.onclick = (e)=>{
        if(!e.target.classList.contains("remove")) toggle(team, p.num);
      };
      div.appendChild(el);
    });

    const st = document.getElementById(team+"Status");
    st.textContent = "Punkte: " + sum.toFixed(1);
    st.className = "status " + (sum<=14.5 ? "ok" : "fail");
  });
}

function downloadLog(){
  let csv = "Zeit;Periode;Team;Spieler;Punkte\n";
  log.forEach(l=>{
    csv += `${l.time};${l.period};${l.team};${l.lineup.join(",")};${l.points}\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "wechselhistorie.csv";
  a.click();
}

render();
</script>

</body>
</html>
